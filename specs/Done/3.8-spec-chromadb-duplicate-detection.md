# 3.8 Specification: ChromaDB Duplicate Detection Fix

## Bug Description

When adding a document to the GraphRAG system, the following error occurs during duplicate detection:

```
Error checking for duplicate by metadata: Expected where to have exactly one operator, got {'title': 'Neural Networks and Deep Learning: A Comprehensive Guide', 'author': 'AI Researcher'} in get.
```

The system is attempting to check for duplicates using multiple metadata fields (title and author), but ChromaDB's API expects a different query structure for the `where` clause.

## Requirements

1. Fix the duplicate detection logic to properly query ChromaDB
2. Ensure the system can check for duplicates using multiple metadata fields
3. Add proper error handling for duplicate detection

## Implementation Details

1. **Query Structure Fix**:
   - Update the duplicate detection logic to use ChromaDB's expected query format
   - For multiple field checks, use logical operators (AND, OR) in the query
   - Example format: `{"$and": [{"title": {"$eq": "Document Title"}}, {"author": {"$eq": "Author Name"}}]}`

2. **Error Handling**:
   - Add try/except blocks around duplicate detection
   - Log detailed error messages for debugging
   - Continue processing even if duplicate detection fails

3. **Testing**:
   - Add tests for duplicate detection with various metadata combinations
   - Verify that documents with the same metadata are properly identified as duplicates
   - Ensure the system handles edge cases (missing metadata, partial matches)

## Acceptance Criteria

1. The system can check for duplicates using multiple metadata fields without errors
2. Duplicate documents are properly identified and handled
3. The system provides clear error messages when duplicate detection fails
4. The system continues processing even if duplicate detection encounters non-critical errors

## Notes

- ChromaDB's query syntax has changed in recent versions, so ensure compatibility with the installed version
- Consider adding a configuration option to specify which metadata fields to use for duplicate detection
- Document the expected format for duplicate detection queries in the code comments